<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="dnt.itsnow.repository.WorkflowRepository">
    <resultMap id="workflowResult" type="Workflow" autoMapping="true">
        <id property="id" column="id"/>
        <!-- 一对一关系 -->
        <association property="actReProcdef" column="act_re_procdef_id" javaType="ActReProcdef" autoMapping="true">
            <id property="id" column="act_re_procdef_id" javaType="java.lang.String" jdbcType="VARCHAR"/>
            <id property="resourceName" column="act_re_procdef_resourceName"/>
            <id property="version" column="act_re_procdef_version"/>
        </association>
        <association property="actReDeployment" javaType="ActReDeployment" autoMapping="true">
            <id property="id" column="act_re_deployment_id" javaType="java.lang.String" jdbcType="VARCHAR"/>
            <id property="name" column="act_re_deployment_name"/>
            <id property="category" column="act_re_deployment_category"/>
            <id property="tenantId" column="act_re_deployment_tenant_id"/>
            <id property="deployTime" column="act_re_deployment_deploy_time"/>
        </association>
        <association property="dictionary" column="process_dictionary_id" javaType="Dictionary">
            <id property="id" column="dictionary_id"/>
            <result property="sn" column="dictionary_sn"/>
            <result property="code" column="dictionary_code"/>
            <result property="name" column="dictionary_name"/>
            <result property="display" column="dictionary_display"/>
            <result property="val" column="dictionary_val"/>
            <result property="state" column="dictionary_state"/>
            <result property="type" column="dictionary_type"/>
        </association>
    </resultMap>

    <sql id="select">
        SELECT flow.id,
        flow.sn,
        flow.name,
        flow.service_item_type,
        flow.description,
        flow.created_at,
        flow.updated_at,
        a.ID_                   AS act_re_procdef_id,
        a.RESOURCE_NAME_        AS act_re_procdef_resourceName,
        a.VERSION_              AS act_re_procdef_version,
        deployment.DEPLOY_TIME_ AS act_re_deployment_deploy_time,
        p.id                    AS dictionary_id,
        p.sn                    AS dictionary_sn,
        p.code                  AS dictionary_code,
        p.name                  AS dictionary_name,
        p.display               AS dictionary_display,
        p.val                   AS dictionary_val,
        p.state                 AS dictionary_state,
        p.type                  AS dictionary_type
        FROM   workflows flow
        LEFT JOIN ACT_RE_PROCDEF a
        ON flow.act_re_procdef_id = a.ID_
        LEFT JOIN ACT_RE_DEPLOYMENT deployment
        ON a.DEPLOYMENT_ID_ = deployment.ID_
        LEFT JOIN dictionaries p
        ON flow.process_dictionary_id = p.id
    </sql>

    <select id="count" resultType="java.lang.Integer">
        SELECT COUNT(0) FROM workflows
        <where>
            <if test="keyword != null and keyword != ''">
                <bind name="pattern" value="'%' + keyword + '%' "/>
                name LIKE #{pattern} OR sn LIKE #{pattern}
            </if>
        </where>
    </select>

    <select id="find" resultMap="workflowResult">
        <include refid="select"/>
        <where>
            <if test="keyword != null and keyword != ''">
                <bind name="pattern" value="'%' + keyword + '%' "/>
                flow.name LIKE #{pattern} OR flow.sn LIKE #{pattern}
            </if>
        </where>
        <if test="pageable.sort != null">
            ORDER BY #{pageable.sort}
        </if>
        <trim prefix="LIMIT" prefixOverrides=",">
            <if test="pageable.offset > 0">#{pageable.offset}</if>
            <if test="pageable.pageSize > 0">, #{pageable.pageSize}</if>
        </trim>
    </select>

    <select id="findBySn" resultMap="workflowResult">
        <include refid="select"/>
        WHERE flow.sn=#{sn}
    </select>

</mapper>
