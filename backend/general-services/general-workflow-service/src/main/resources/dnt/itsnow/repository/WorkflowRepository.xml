<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="dnt.itsnow.repository.WorkflowRepository">

    <resultMap id="workflowResult" type="Workflow" autoMapping="true">
        <id property="id" column="id"/>
        <!-- 一对一关系 -->
        <association property="actReProcdef" column="ACT_RE_PROCDEF_ID" javaType="ActReProcdef" autoMapping="true">
            <id property="id" column="act_re_procdef_id" javaType="java.lang.String" jdbcType="VARCHAR"/>
            <id property="resourceName" column="act_re_procdef_resourcename"/>
            <id property="version" column="act_re_procdef_version"/>
        </association>
        <!-- 一对一关系 -->
        <association property="actReDeployment" javaType="ActReDeployment" autoMapping="true">
            <id property="id" column="act_re_deployment_id" javaType="java.lang.String" jdbcType="VARCHAR"/>
            <id property="name" column="act_re_deployment_name"/>
            <id property="category" column="act_re_deployment_category"/>
            <id property="tenantId" column="act_re_deployment_tenant_id"/>
            <id property="deployTime" column="act_re_deployment_deploy_time"/>
        </association>
    </resultMap>

    <sql id="select">
        SELECT
            flow.*,
            a.ID_                   AS act_re_procdef_id,
            a.RESOURCE_NAME_        AS act_re_procdef_resourceName,
            a.VERSION_              AS act_re_procdef_version,
            deployment.ID_          AS act_re_deployment_id,
            deployment.NAME_        AS act_re_deployment_name,
            deployment.CATEGORY_    AS act_re_deployment_category,
            deployment.TENANT_ID_   AS act_re_deployment_tenant_id,
            deployment.DEPLOY_TIME_ AS act_re_deployment_deploy_time
        FROM workflows flow
            LEFT JOIN ACT_RE_PROCDEF a
                ON flow.act_re_procdef_id = a.ID_
            LEFT JOIN ACT_RE_DEPLOYMENT deployment
                ON a.DEPLOYMENT_ID_ = deployment.ID_
    </sql>

    <select id="count" resultType="java.lang.Integer">
        SELECT COUNT(0) FROM workflows
        <where>
            <if test="keyword != null and keyword != ''">
                <bind name="pattern" value="'%' + keyword + '%' "/>
                name LIKE #{pattern} OR sn LIKE #{pattern}
            </if>
        </where>
    </select>

    <select id="findAll" resultMap="workflowResult">
        <include refid="select"/>
        <where>
            <if test="keyword != null and keyword != ''">
                <bind name="pattern" value="'%' + keyword + '%' "/>
                flow.name LIKE #{pattern} OR flow.sn LIKE #{pattern}
            </if>
        </where>
        <if test="pageable.sort != null">
            ORDER BY #{pageable.sort}
        </if>
        <trim prefix="LIMIT" prefixOverrides=",">
            <if test="pageable.offset > 0">#{pageable.offset}</if>
            <if test="pageable.pageSize > 0">, #{pageable.pageSize}</if>
        </trim>
    </select>

    <select id="findBySn" resultMap="workflowResult">
        <include refid="select"/>
        WHERE flow.sn=#{sn}
    </select>

</mapper>
